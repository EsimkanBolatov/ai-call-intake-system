; Asterisk dialplan for AI Call Intake System (102 service)
; This configuration handles incoming calls to private number
; and routes them to Python AGI script for AI processing

[general]
static=yes
writeprotect=no
clearglobalvars=no

; Global variables (can be set via environment or CLI)
; AI_SCRIPT_PATH - path to Python AGI script
; RECORDINGS_DIR - directory for call recordings

[globals]
AI_SCRIPT_PATH=/opt/ai-call-intake/agi/call_handler.py
RECORDINGS_DIR=/var/spool/asterisk/monitor
MAX_CALL_DURATION=300          ; maximum call duration in seconds (5 minutes)
LANGUAGE=ru                    ; default language for TTS (ru/kk)

; Main incoming context for SIP trunk
[incoming]

; Pattern for any incoming call (adjust to match your SIP trunk/DID)
; This example matches any 10-digit number (for testing)
exten => _+XXXXXXXXXX,1,NoOp(=== AI Call Intake: Incoming call from ${CALLERID(num)} ===)
	same => n,Answer()
	
	; Set channel variables
	same => n,Set(CALLER_ID=${CALLERID(num)})
	same => n,Set(CALL_UNIQUE_ID=${UNIQUEID})
	same => n,Set(START_TIME=${STRFTIME(${EPOCH},,%Y-%m-%d %H:%M:%S)})
	
	; Record the call (mixed audio) for logging and analysis
	same => n,Set(RECORDING_FILE=${RECORDINGS_DIR}/${STRFTIME(${EPOCH},,%Y%m%d-%H%M%S)}_${CALL_UNIQUE_ID}.wav)
	same => n,Monitor(wav,${RECORDING_FILE},m)
	
	; Execute Python AGI script for AI processing
	same => n,AGI(${AI_SCRIPT_PATH},${CALLER_ID},${LANGUAGE})
	
	; If AGI script returns, play goodbye message and hang up
	same => n,NoOp(AGI script finished, playing goodbye)
	same => n,Playback(vm-goodbye)
	same => n,Hangup()

; Fallback extension for any other incoming call
exten => i,1,NoOp(Invalid extension)
	same => n,Playback(invalid)
	same => n,Hangup()

; Timeout handling
exten => t,1,NoOp(Timeout)
	same => n,Playback(tt-weasels)
	same => n,Hangup()

; Busy handling
exten => b,1,NoOp(Busy)
	same => n,Playback(privacy-incorrect)
	same => n,Hangup()

; Internal testing extension (from console)
[internal-test]
exten => 500,1,NoOp(=== Testing AI Call Intake ===)
	same => n,Answer()
	same => n,Set(CALLER_ID=TEST_${STRFTIME(${EPOCH},,%H%M%S)})
	same => n,Set(LANGUAGE=ru)
	same => n,AGI(${AI_SCRIPT_PATH},${CALLER_ID},${LANGUAGE})
	same => n,Hangup()

; Direct AGI test without answer (for debugging)
exten => 501,1,NoOp(=== Direct AGI Test ===)
	same => n,AGI(${AI_SCRIPT_PATH},TEST_DEBUG,ru)
	same => n,Hangup()

; Manual call simulation (play greeting and record)
exten => 502,1,NoOp(=== Manual Simulation ===)
	same => n,Answer()
	same => n,Playback(custom/ai_greeting_ru)  ; Pre-recorded greeting
	same => n,Wait(2)
	same => n,Record(${RECORDINGS_DIR}/manual_test.wav,0,10)
	same => n,Playback(beep)
	same => n,Playback(vm-goodbye)
	same => n,Hangup()

; Utility extensions for system management
[utilities]
exten => 600,1,NoOp(=== System Status ===)
	same => n,Verbose(1, AI Call Intake System Status)
	same => n,Verbose(1, AI Script Path: ${AI_SCRIPT_PATH})
	same => n,Verbose(1, Recordings Dir: ${RECORDINGS_DIR})
	same => n,Playback(beep)
	same => n,Hangup()

exten => 601,1,NoOp(=== List Recent Recordings ===)
	same => n,System(ls -la ${RECORDINGS_DIR}/*.wav 2>/dev/null | head -5)
	same => n,Playback(beep)
	same => n,Hangup()