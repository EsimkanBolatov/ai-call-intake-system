# Архитектура системы AI-колл-интейк для 102 службы

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ВХОДЯЩИЙ ЗВОНОК (Caller)                          │
│                    SIP/GSM/API → Частный телефонный номер                  │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Asterisk PBX                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ extensions.conf:                                                    │   │
│  │   exten => _X.,1,Answer()                                           │   │
│  │   exten => _X.,n,AGI(call_handler.py)                               │   │
│  │   exten => _X.,n,Hangup()                                           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│  Задачи:                                                                   │
│  • Автоответ                                                               │
│  • Запись аудио (monitor)                                                  │
│  • Взаимодействие с Python AGI скриптом                                    │
│  • Воспроизведение TTS аудио                                               │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Python AGI Backend (call_handler.py)                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ 1. Получает caller ID, channel                                      │   │
│  │ 2. Воспроизводит приветствие (TTS)                                  │   │
│  │ 3. Записывает ответ пользователя                                    │   │
│  │ 4. Отправляет аудио в STT сервис                                     │   │
│  │ 5. Получает текст → передаёт в LLM                                   │   │
│  │ 6. LLM возвращает JSON с классификацией                             │   │
│  │ 7. Генерирует ответ через TTS                                        │   │
│  │ 8. Воспроизводит ответ                                               │   │
│  │ 9. Логирует всё в БД                                                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                 ┌──────────────┼──────────────┐
                 ▼              ▼              ▼
    ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
    │   STT сервис   │  │    LLM сервис  │  │   TTS сервис   │
    │   (Whisper)    │  │ (OpenAI/Deep- │  │ (Coqui/OpenAI) │
    │                │  │    Seek)      │  │                │
    │ • offline      │  │ • GPT-4/3.5   │  │ • offline/API  │
    │ • или API      │  │ • или локаль- │  │ • русский/     │
    │ • русский/     │  │   ный модель  │  │   казахский    │
    │   казахский    │  │ • строгий     │  │                │
    └───────────────┘  │   JSON формат  │  └───────────────┘
                       └───────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Классификация и JSON                               │
│  {                                                                          │
│    "urgency": "critical|high|medium|low",                                   │
│    "category": "theft|assault|domestic|noise|traffic|...",                  │
│    "address": "ул. Примерная, 12",                                          │
│    "current_danger": true/false,                                            │
│    "people_involved": 2,                                                    │
│    "weapons": true/false,                                                   │
│    "recommended_department": "Полиция|Скорая|МЧС|Акимат",                   │
│    "summary": "Краткое описание инцидента"                                  │
│  }                                                                          │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Логирование                                    │
│  • SQLite/PostgreSQL таблица calls                                         │
│  • Поля: timestamp, caller_id, audio_path, transcript, ai_json, status     │
│  • Индексы для поиска                                                       │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Dashboard (Flask, опционально)                      │
│  • Просмотр последних звонков                                               │
│  • Фильтрация по urgency                                                    │
│  • Просмотр JSON деталей                                                    │
│  • Экспорт в CSV                                                            │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Детализация потоков данных

### 1. Поток звонка

```
Caller → SIP Trunk → Asterisk (dialplan) → AGI скрипт →
→ Приветствие (TTS) → Запись ответа → STT → Текст →
→ LLM → JSON → Ответ (TTS) → Завершение → Логирование
```

### 2. Поток обработки аудио

```
Raw audio (μ‑law/PCM) → WAV конвертация →
→ Whisper STT → Текст → Очистка →
→ LLM prompt → JSON parsing →
→ TTS текст → Coqui TTS → WAV →
→ Asterisk playback
```

### 3. Поток логирования

```
Каждое событие → SQLite insert →
→ timestamp, caller_id, stage, data →
→ Возможность запроса через API
```

## Компоненты и технологии

| Компонент         | Технология                         | Назначение                              |
| ----------------- | ---------------------------------- | --------------------------------------- |
| Телефония         | Asterisk 18+                       | Приём звонков, маршрутизация, запись    |
| Backend обработки | Python 3.10+, FastAPI/AGI          | Оркестрация STT/LLM/TTS, логика диалога |
| STT               | Whisper (offline) / Google STT API | Преобразование речи в текст             |
| LLM               | OpenAI GPT‑4/3.5 / DeepSeek        | Анализ текста, классификация, JSON      |
| TTS               | Coqui TTS / OpenAI TTS             | Преобразование текста в речь            |
| Хранилище         | SQLite / PostgreSQL                | Логи звонков, метаданные                |
| Dashboard         | Flask + Bootstrap                  | Мониторинг для операторов               |
| Конфигурация      | .env файлы                         | Ключи API, параметры                    |

## Требования к инфраструктуре

- Ubuntu 20.04/22.04 LTS
- Минимум 4 ГБ ОЗУ (для Whisper + Coqui)
- 20 ГБ свободного места (для моделей и записей)
- Статический IP для SIP trunk (опционально)
- Интернет‑доступ для API (если используется облачный LLM/STT)

## Масштабирование

Архитектура поддерживает горизонтальное масштабирование:

- Несколько Asterisk серверов с балансировкой
- Микросервисная организация STT/LLM/TTS
- Redis для кэширования и очередей
- Kubernetes для оркестрации
