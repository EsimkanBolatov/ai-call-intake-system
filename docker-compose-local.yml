version: "3.8"

services:
  # SQLite база данных (бесплатно, локально)
  sqlite:
    image: alpine:latest
    container_name: ai-call-local-sqlite
    volumes:
      - ./data:/data
    command: sh -c "mkdir -p /data && echo 'SQLite volume created' && tail -f /dev/null"
    networks:
      - local-network

  # Asterisk телефония (локальный)
  asterisk:
    image: andrius/asterisk:18
    container_name: ai-call-local-asterisk
    depends_on:
      - ai-backend
    environment:
      - TZ=Asia/Almaty
    volumes:
      - ./asterisk/config:/etc/asterisk
      - ./agi:/var/lib/asterisk/agi-bin
      - ./recordings:/var/spool/asterisk/monitor
      - ./logs/asterisk:/var/log/asterisk
    ports:
      - "5060:5060/udp"
      - "5060:5060/tcp"
      - "10000-10010:10000-10010/udp"
    networks:
      - local-network
    restart: unless-stopped
    command: sh -c "echo 'Starting local Asterisk for testing...' && asterisk -f -C /etc/asterisk/asterisk.conf"

  # Python Backend (локальный, с mock режимами)
  ai-backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: ai-call-local-backend
    depends_on:
      - sqlite
    environment:
      - DATABASE_URL=sqlite:///data/calls.db
      - OPENAI_API_KEY=${OPENAI_API_KEY:-mock}
      - STT_ENGINE=${STT_ENGINE:-whisper}
      - LLM_ENGINE=${LLM_ENGINE:-mock}
      - TTS_ENGINE=${TTS_ENGINE:-mock}
      - DEFAULT_LANGUAGE=kk
      - DEBUG_MODE=true
      - LOG_LEVEL=DEBUG
    volumes:
      - ./services:/app/services
      - ./agi:/app/agi
      - ./data:/app/data
      - ./logs:/app/logs
      - ./tts_cache:/app/tts_cache
    ports:
      - "8000:8000"
    networks:
      - local-network
    restart: unless-stopped
    command: >
      sh -c "
        echo 'Starting AI Backend in LOCAL mode...'
        echo 'STT Engine: ${STT_ENGINE:-whisper}'
        echo 'LLM Engine: ${LLM_ENGINE:-mock}'
        echo 'TTS Engine: ${TTS_ENGINE:-mock}'
        python -c 'from services.logger import CallLogger; logger = CallLogger(); logger.initialize_database(); print(\"Database initialized\")'
        uvicorn main:app --host 0.0.0.0 --port 8000 --reload
      "

  # Flask Dashboard (локальный)
  dashboard:
    build:
      context: ./dashboard
      dockerfile: Dockerfile.dashboard
    container_name: ai-call-local-dashboard
    depends_on:
      - ai-backend
    environment:
      - BACKEND_URL=http://ai-backend:8000
      - DATABASE_URL=sqlite:///data/calls.db
      - SECRET_KEY=local-test-key-change-in-production
      - DEBUG_MODE=true
    volumes:
      - ./dashboard:/app
      - ./data:/app/data
    ports:
      - "5000:5000"
    networks:
      - local-network
    restart: unless-stopped
    command: sh -c "echo 'Starting local Dashboard...' && python app.py"

  # Тестовый SIP клиент (для автоматического тестирования)
  sip-test-client:
    image: alpine:latest
    container_name: ai-call-local-sip-test
    depends_on:
      - asterisk
    volumes:
      - ./scripts:/scripts
    networks:
      - local-network
    command: >
      sh -c "
        echo 'Waiting for Asterisk to start...'
        sleep 30
        echo 'Running test call...'
        apk add --no-cache sipcmd
        sipcmd -u 600 -c 600 -P sip -w asterisk -x 'c500' || echo 'Test call completed'
      "
    restart: "no"

volumes:
  data:
  recordings:
  tts_cache:

networks:
  local-network:
    driver: bridge
